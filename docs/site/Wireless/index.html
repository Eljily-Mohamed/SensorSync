<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="https://Eljily-Mohamed.github.io/project_emb_docs/Wireless/">
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Wireless Connection - Emb Docs</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/fontawesome.min.css" rel="stylesheet">
        <link href="../css/brands.min.css" rel="stylesheet">
        <link href="../css/solid.min.css" rel="stylesheet">
        <link href="../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">Emb Docs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href=".." class="nav-link">Project Homepage</a>
                            </li>
                            <li class="nav-item">
                                <a href="../IHM/" class="nav-link">IHM System Overview</a>
                            </li>
                            <li class="nav-item">
                                <a href="../SHT40_SENSOR/" class="nav-link">SHT40 SENSOR</a>
                            </li>
                            <li class="nav-item">
                                <a href="../TCS3414CS_SENSOR/" class="nav-link">TCS34725CS SENSOR</a>
                            </li>
                            <li class="nav-item">
                                <a href="../Test/" class="nav-link">Test</a>
                            </li>
                            <li class="nav-item">
                                <a href="./" class="nav-link active" aria-current="page">Wireless Connection</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../Test/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" class="nav-link disabled">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#wireless-connection" class="nav-link">Wireless Connection</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#zigbee" class="nav-link">Zigbee</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#uart1-configuration-steps" class="nav-link">UART1 Configuration Steps</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#uart1-initialization-and-callback" class="nav-link">UART1 Initialization and Callback</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#test" class="nav-link">Test</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#bluetooth-low-energy-ble" class="nav-link">Bluetooth Low Energy (BLE)</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#hardware-requirements" class="nav-link">Hardware Requirements</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#configuring-our-services" class="nav-link">Configuring Our Services</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#summary" class="nav-link">Summary</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="wireless-connection">Wireless Connection</h1>
<h1 id="zigbee">Zigbee</h1>
<p>Zigbee is a wireless communication protocol designed for low-power, low-data-rate applications. It operates on the IEEE 802.15.4 standard and is commonly used in home automation, industrial control, and sensor networks. Zigbee networks can support hundreds of devices, making it suitable for applications requiring long battery life and reliable communication over short to medium distances.</p>
<h2 id="uart1-configuration-steps">UART1 Configuration Steps</h2>
<p>To configure UART1 in the .config file and define different pins and GPIO configurations:</p>
<pre><code class="language-cpp">
  // USART1
#define USE_USART1
#define USART1_GPIO_PORT    _GPIOB
#define USART1_GPIO_PINS    PIN_3
#define USART1_GPIO_CFG     PIN_MODE_ALTFUNC | PIN_OPT_AF7

// USART2
#define USE_USART2
#define USART2_GPIO_PORT    _GPIOA
#define USART2_GPIO_PINS    PIN_2 | PIN_3 | PIN_9
#define USART2_GPIO_CFG     PIN_MODE_ALTFUNC | PIN_OPT_AF7

</code></pre>
<p>For more details, check the documentation, and you need to be familiar with using the ENIB Kit for Embedded Systems</p>
<h2 id="uart1-initialization-and-callback">UART1 Initialization and Callback</h2>
<pre><code class="language-cpp">
  int uart_init(USART_t *u, uint32_t baud, uint32_t mode, OnUartRx cb)
{
    IRQn_t irq_number;
    uint32_t irq_priority;

    if (u == _USART1) {
#ifdef USE_USART1
        // Enable USART clocking
        _RCC-&gt;APB2ENR |= (1 &lt;&lt; 4); 
        // Configure Tx/Rx pins
        io_configure(USART1_GPIO_PORT, USART1_GPIO_PINS, USART1_GPIO_CFG, NULL);
        usart1_cb = cb;
        irq_number = USART1_IRQn;
        irq_priority = USART1_IRQ_PRIORITY;
        // Configure USART speed
        u-&gt;BRR = sysclks.apb2_freq / baud;
#else
        return -1; // USART1 not enabled
#endif
    }

    /*Reset usart conf */
    u-&gt;CR1&amp;=~(1&lt;&lt;12); //nb de bit par data raz
    u-&gt;CR1&amp;=~(7&lt;&lt;8);  //parité raz
    u-&gt;CR2&amp;=~(3&lt;&lt;12); //bit stop

    u-&gt;GTPR = 0;
    u-&gt;CR3 = 0;
    /*conf à partir mode */
    /*  mode = b10-b9-b8-x-x-b5-b4-x-x-x-b0
        b0 = 8/9 bits dans CR1 b12
        b5/b4 = nb bit stop dans CR2 b13/b12
        b10/b9/b8 = parité , 10 controle parité (1 activé/0 désactivé), 9 type parité (Odd/Even) , 8 PEIE parity Error interrupt enable
    */
        u-&gt;CR1 |=((mode &amp; 0x1)&lt;&lt;12) | (mode &amp; 0x700) | (3&lt;&lt;2) | (1&lt;&lt;13);  //conf + tx/rx activé + usart enable
        u-&gt;CR2 |=((mode &amp; 0x30)&lt;&lt;8); //bit stop positionné en b12/b13 de CR2

        // Setup NVIC
        if (cb) {
            /* A COMPLETER */
            NVIC_SetPriority(irq_number, irq_priority);
            NVIC_EnableIRQ(irq_number);
            u-&gt;CR1 |= (1&lt;&lt;5);// Receiver Not Empty Interrupt Enable

        }
}

</code></pre>
<h2 id="test">Test</h2>
<p>In the main file, we need to add a callback function to handle communication via Zigbee:</p>
<pre><code class="language-cpp">
static void on_zigbee_command_received(char c) {
    command = c;
    uart_printf(UART_TO_USE, &quot;\r\nZigbee command received: %c\r\n&quot;, c);
}

// Initialization required
uart_init(_USART2, 115200, UART_8N1, on_command_received);
uart_init(_USART1, 115200, UART_8N1, on_zigbee_command_received);

</code></pre>
<p>Now that we have completed these steps, we can verify if everything functions correctly by conducting the same test mentioned in the section above, but using the 'tty/USB0' port.</p>
<h1 id="bluetooth-low-energy-ble">Bluetooth Low Energy (BLE)</h1>
<p>Bluetooth Low Energy (BLE) is a wireless communication technology designed for short-range communication with minimal power consumption. It is commonly used in applications such as wearable devices, smart home products, and health monitoring systems.</p>
<h2 id="hardware-requirements">Hardware Requirements</h2>
<ul>
<li><strong>X-NUCLEO-IDB05A2</strong>: This is a Bluetooth Low Energy (BLE) expansion board based on the SPBTLE-RF module. It can be used with STM32 Nucleo development boards to add BLE functionality to your projects.</li>
</ul>
<h2 id="configuring-our-services">Configuring Our Services</h2>
<h3 id="temperature-service">Temperature Service</h3>
<p>To create a BLE service for temperature data, we use the characteristic UUID <code>0x2A6E</code>.</p>
<pre><code class="language-cpp">// TEMPERATURE CHAR : 0x2A6E
primary_short_uuid[0] = 0x6E;
primary_short_uuid[1] = 0x2A;
ret = aci_gatt_add_char(HWServW2STHandle, UUID_TYPE_16, primary_short_uuid, 2,
                        CHAR_PROP_NOTIFY | CHAR_PROP_READ,
                        ATTR_PERMISSION_NONE,
                        GATT_NOTIFY_READ_REQ_AND_WAIT_FOR_APPL_RESP,
                        16, 0, &amp;TemperatureCharHandle);

if (ret != BLE_STATUS_SUCCESS) {
    goto fail;
}
HAL_Delay(100);

</code></pre>
<h3 id="color-temperature-service">Color Temperature Service</h3>
<p>To create a BLE service for color temperature data, we use the characteristic UUID 0x2A63.</p>
<pre><code class="language-cpp">// Color temp 0x2A63
primary_short_uuid[0] = 0x63;
primary_short_uuid[1] = 0x2A;
ret = aci_gatt_add_char(HWServW2STHandle, UUID_TYPE_16, primary_short_uuid, 2,
                        CHAR_PROP_NOTIFY | CHAR_PROP_READ,
                        ATTR_PERMISSION_NONE,
                        GATT_NOTIFY_READ_REQ_AND_WAIT_FOR_APPL_RESP,
                        16, 0, &amp;TempColorCharHandle);

if (ret != BLE_STATUS_SUCCESS) {
    goto fail;
}
HAL_Delay(100);

return BLE_STATUS_SUCCESS;

fail:
return BLE_STATUS_ERROR;

</code></pre>
<h3 id="updating-environmental-data">Updating Environmental Data</h3>
<p>The function Environmental_Update updates the temperature and color temperature values</p>
<pre><code class="language-cpp">
tBleStatus Environmental_Update(int16_t Temp, int16_t color_temp)
{
    tBleStatus ret;
    uint8_t buff_Temp[2];
    uint8_t buff_color_temp[2];

    STORE_LE_16(buff_Temp, Temp);
    ret = aci_gatt_update_char_value(HWServW2STHandle, TemperatureCharHandle, 0, 2, buff_Temp);
    if (ret != BLE_STATUS_SUCCESS) {
        return BLE_STATUS_ERROR;
    }

    STORE_LE_16(buff_color_temp, color_temp);
    ret = aci_gatt_update_char_value(HWServW2STHandle, TempColorCharHandle, 0, 2, buff_color_temp);
    if (ret != BLE_STATUS_SUCCESS) {
        return BLE_STATUS_ERROR;
    }

    return BLE_STATUS_SUCCESS;
}

</code></pre>
<h3 id="sending-data">Sending Data</h3>
<p>After receiving a notification, you can send the updated values</p>
<pre><code class="language-cpp">
void SendEnvironmentalData(void)
{
    static float temperature, humidity;
    uint16_t red, green, blue, clear, color_temp;
    float x, y;
    int32_t TempToSend = 0;
    int32_t decPart, intPart;
    int16_t ret;
    ret = sht4x_measure_blocking_read(&amp;temperature, &amp;humidity);
    tcs34725_read_color(&amp;red, &amp;green, &amp;blue, &amp;clear);
    color_temp = calculateColorTemperature(red, green, blue, &amp;x, &amp;y);
    MCR_BLUEMS_F2I_1D(temperature, intPart, decPart);
    TempToSend = intPart * 10 + decPart;
    printf(&quot;\r\ntemperature: %d.%d C&quot;, intPart, decPart);
    printf(&quot;\r\ntemperature en kelvin: %d K&quot;, color_temp);
    Environmental_Update(TempToSend, color_temp);
    HAL_Delay(1000);
}

</code></pre>
<h2 id="summary">Summary</h2>
<p>In this project, we successfully set up a Bluetooth Low Energy (BLE) communication system using the X-NUCLEO-IDB05A2 expansion board. We configured services for both temperature and color temperature data, updated these values, and sent the data using BLE notifications.</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js"></script>
        <script src="../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
