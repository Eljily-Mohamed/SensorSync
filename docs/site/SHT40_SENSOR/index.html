<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="https://Eljily-Mohamed.github.io/project_emb_docs/SHT40_SENSOR/">
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>SHT40 SENSOR - Emb Docs</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/fontawesome.min.css" rel="stylesheet">
        <link href="../css/brands.min.css" rel="stylesheet">
        <link href="../css/solid.min.css" rel="stylesheet">
        <link href="../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">Emb Docs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href=".." class="nav-link">Project Homepage</a>
                            </li>
                            <li class="nav-item">
                                <a href="../IHM/" class="nav-link">IHM System Overview</a>
                            </li>
                            <li class="nav-item">
                                <a href="./" class="nav-link active" aria-current="page">SHT40 SENSOR</a>
                            </li>
                            <li class="nav-item">
                                <a href="../TCS3414CS_SENSOR/" class="nav-link">TCS34725CS SENSOR</a>
                            </li>
                            <li class="nav-item">
                                <a href="../Test/" class="nav-link">Test</a>
                            </li>
                            <li class="nav-item">
                                <a href="../Wireless/" class="nav-link">Wireless Connection</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../IHM/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../TCS3414CS_SENSOR/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#sht40-sensor" class="nav-link">SHT40 SENSOR</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#hardware-components" class="nav-link">Hardware Components</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#software-implementation" class="nav-link">Software Implementation</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#project-structure" class="nav-link">Project Structure</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#essential-functions-for-sensor-communication" class="nav-link">Essential Functions for Sensor Communication</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#key-details-about-the-sht40-sensor" class="nav-link">Key Details about the SHT40 Sensor</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#sensor-initialization" class="nav-link">Sensor Initialization</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#task-one" class="nav-link">Task One</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#task-two" class="nav-link">Task Two</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#summary" class="nav-link">Summary</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="sht40-sensor">SHT40 SENSOR</h1>
<p><img src="grove_sht40.jpeg" alt="Grove SHT40" width="400"></br>
This section provides a detailed explanation of the embedded system aspect of our project, focusing specifically on the Grove SHT40 Temperature and Humidity Sensor.</p>
<h2 id="hardware-components">Hardware Components</h2>
<h4 id="microcontroller-development-kit">Microcontroller Development Kit</h4>
<p>We utilize an STM32 microcontroller development kit to build and debug code for our project. This development kit is provided by the ENIB internal pack used in our course (SDK pack), enabling efficient development and debugging of firmware for the embedded system.</p>
<h2 id="software-implementation">Software Implementation</h2>
<p>Before we can utilize the SHT40 sensor, it is crucial to establish communication with it using the I2C protocol and configure it with the appropriate settings. To achieve this, we need to implement basic functions that facilitate communication with the sensor. These functions serve as the foundation for all subsequent interactions with the sensor.</p>
<h2 id="project-structure">Project Structure</h2>
<p>To integrate the SHT40 sensor into our project, you'll need to follow these steps:</p>
<ol>
<li>Create the necessary files:</li>
<li><code>sht40.h</code>: Header file for SHT40 sensor interface.</li>
<li><code>sht40.c</code>: Source file for SHT40 sensor implementation.</li>
</ol>
<h2 id="essential-functions-for-sensor-communication">Essential Functions for Sensor Communication</h2>
<p>To interact with the SHT40 sensor, we implement the following fundamental functions:</p>
<ol>
<li><strong><code>sht4x_write(uint8_t reg, uint8_t value)</code>:</strong> This function writes a single byte of data to a specified register of the sensor..</li>
</ol>
<pre><code class="language-cpp">
    static int16_t sht4x_write(uint8_t reg, uint8_t value) {
        uint8_t data[2];
        data[0] = reg;
        data[1] = value &amp; 0xFF;
        return i2c_write(I2C1, SHT4X_ADDRESS, data, sizeof(data));
    }

</code></pre>
<ol>
<li><strong><code>read(uint8_t reg , int delay)</code>:</strong> This function reads a single byte of data from a specified register of the sensor.</li>
</ol>
<pre><code class="language-cpp">
    static uint8_t sht4x_read(uint8_t reg, int delay) {
        uint8_t value;
        uint8_t reg_data[1] = {reg};

        if (i2c_write(I2C1, SHT4X_ADDRESS, reg_data, 1) != I2C_OK) {
            uart_puts(_USART2, &quot;\n\rErreur lors de l'écriture dans le registre\n&quot;);
            return 0;
        }

        delay_us(delay);

        if (i2c_read(I2C1, SHT4X_ADDRESS, &amp;value, 1) != I2C_OK) {
            uart_puts(_USART2, &quot;\n\rErreur lors de la lecture d'octets\n&quot;);
            return 0;
        }

        return value;
    }

</code></pre>
<ol>
<li><strong><code>write_n(uint8_t reg, uint8_t* values, uint8_t length)</code>:</strong> This function writes multiple bytes of data to consecutive registers of the sensor.</li>
</ol>
<pre><code class="language-cpp">
    static int16_t sht4x_write_n(uint8_t reg, uint8_t* values, uint8_t length) {
        uint8_t data[length + 1];
        data[0] = reg;
        for (size_t i = 0; i &lt; length; i++) {
            data[i + 1] = values[i];
        }
        return i2c_write(I2C1, SHT4X_ADDRESS, data, sizeof(data));
    }

</code></pre>
<ol>
<li><strong><code>read_n(uint8_t reg, uint8_t* values, uint8_t length, int delay)</code>:</strong> This function reads multiple bytes of data from consecutive registers of the sensor.</li>
</ol>
<pre><code class="language-cpp">
    void read_n(uint8_t reg, uint8_t* values, uint8_t length, int delay) {
        uint8_t reg_data[1] = {reg};

        if (i2c_write(I2C1, SHT4X_ADDRESS, reg_data, 1) != I2C_OK) {
            uart_puts(_USART2,&quot;\n\rErreur lors de l'écriture dans le registre\n&quot;);
            return I2C_ERROR;
        }

        delay_us(delay);

        if (i2c_read(I2C1, SHT4X_ADDRESS, values, length) != I2C_OK) {
            uart_puts(_USART2,&quot;\n\rErreur lors de la lecture d'octets\n&quot;);
            return;
        }
    }

</code></pre>
<ol>
<li><strong><code>sht4x_write_cmd(const uint8_t* cmd)</code>:</strong> This function writes a command to the sensor.</li>
</ol>
<pre><code class="language-cpp">    static int16_t sht4x_write_cmd(const uint8_t* cmd) {
        return i2c_write(I2C1, SHT4X_ADDRESS, cmd, 1);
    }
</code></pre>
<ol>
<li><strong><code>sht4x_write_cmd(const uint8_t* cmd)</code>:</strong> This function writes a command to the sensor.</li>
</ol>
<pre><code class="language-cpp">    static int16_t sht4x_write_cmd(const uint8_t* cmd) {
        return i2c_write(I2C1, SHT4X_ADDRESS, cmd, 1);
    }
</code></pre>
<p>These functions provide the necessary groundwork for interacting with the SHT40 sensor via the I2C protocol. Once implemented, we can proceed with initializing the sensor and configuring it according to our project requirements.</p>
<h2 id="key-details-about-the-sht40-sensor">Key Details about the SHT40 Sensor</h2>
<h4 id="i2c-communication">I2C Communication:</h4>
<ul>
<li><strong>Specification:</strong> Based on NXP’s I2C-bus specification.</li>
<li><strong>Supported Modes:</strong> Standard, fast mode, and fast mode plus.</li>
<li><strong>Data Transfer:</strong> Transferred in multiples of 16-bit words with an 8-bit checksum (CRC).</li>
<li><strong>Addressing:</strong> 7-bit I2C address followed by an eighth bit, denoting communication direction.</li>
<li><strong>Documentation:</strong> <a href="https://wiki.seeedstudio.com/Grove-SHT4x/">SHT40 Documentation</a></li>
</ul>
<h4 id="data-type-length">Data Type &amp; Length:</h4>
<ul>
<li><strong>Operates with:</strong> 8-bit data packages.</li>
<li><strong>Checksum:</strong> Included after every second 8-bit data package.</li>
<li><strong>Transmission:</strong> Humidity and temperature data transmitted in a specific format.</li>
</ul>
<h4 id="checksum-calculation">Checksum Calculation:</h4>
<ul>
<li><strong>For Read Transfers:</strong> Each 16-bit data is followed by a checksum using CRC-8 algorithm.</li>
</ul>
<h4 id="command-overview">Command Overview:</h4>
<ul>
<li><strong>Various Commands:</strong> Available for different operations like measuring temperature and humidity, reading serial number, etc.</li>
</ul>
<p>Refer to the <a href="https://wiki.seeedstudio.com/Grove-SHT4x/">documentation</a> for detailed specifications and usage instructions.</p>
<h2 id="sensor-initialization">Sensor Initialization</h2>
<p>To use the SHT40 sensor, we need to initialize the I2C communication and configure the sensor. For initialization, we first read the serial number to ensure that the sensor is connected and functioning properly. The process involves detecting if a sensor is connected by reading the ID register. If the sensor does not respond or if the response is not the expected value, the test fails.</p>
<pre><code class="language-cpp">/**
 * Detects if a sensor is connected by reading out the ID register. If the sensor does not answer
 * or if the answer is not the expected value, the test fails.
 *
 * @return 0 if a sensor was detected
 */
int16_t sht4x_probe(void);

int16_t sht4x_probe(void) {
    uint32_t serial;
    return sht4x_read_serial(&amp;serial);
}

</code></pre>
<pre><code class="language-cpp">// Internal function to retrieve the number of words divided by the word size (2 bytes)
#define SENSIRION_WORD_SIZE 2
#define SENSIRION_NUM_WORDS(x) (sizeof(x) / SENSIRION_WORD_SIZE)

// Duration necessary to write command
#define SHT4X_CMD_DURATION_USEC 

int16_t sht4x_read_serial(uint32_t* serial) {
    const uint8_t cmd = SHT4X_CMD_READ_SERIAL;
    int16_t ret;
    uint16_t serial_words[SENSIRION_NUM_WORDS(*serial)];
    ret = write_cmd(&amp;sht4x_cmd_measure);
    if (ret)
        return ret;
    read_n((uint8_t*)serial_words,sizeof(serial_words));
    *serial = ((uint32_t)serial_words[0] &lt;&lt; 16) | serial_words[1];
    return I2C_OK;
}

</code></pre>
<h2 id="task-one">Task One</h2>
<p>After initialization, we can now retrieve the temperature and humidity data. To do this, we need to create a function that allows us to read the temperature and humidity. Below is the function we developed:</p>
<pre><code class="language-cpp">int16_t sht4x_measure_blocking_read(float* temperature, float* humidity) {
    int16_t ret;
    ret = write_cmd(&amp;sht4x_cmd_measure);
    if (ret)
        return ret;
    delay_us(sht4x_cmd_measure_delay_us);
    return sht4x_read_measurement(temperature, humidity);
}

</code></pre>
<h4 id="function-explanation">Function Explanation</h4>
<p>To read the temperature, we start by writing a command. After this, we can read the data. Similar to other sensors where a register pointer is used, we first send a write header to the I2C slave followed by a command. For example, "measure RH&amp;T with highest precision." After the measurement is finished, the read request directed to the I2C slave will be acknowledged, and the transmission of data will be started by the slave.</p>
<h4 id="here-is-an-image-explaining-the-process">Here is an image explaining the process:</h4>
<p><img src="write.png" alt="Grove SHT40" width="1000"></p>
<p>After sending the command, we can read the temperature and humidity. We need to use a formula to convert each value correctly. Refer to the documentation <a href="https://wiki.seeedstudio.com/Grove-SHT4x/">SHT40 Documentation</a> for more details.</p>
<pre><code class="language-cpp">
int16_t sht4x_read_measurement(float* temperature, float* humidity) {
    uint16_t rawTemp, rawHumd;
    uint16_t words[2];
    int16_t ret = read_n(words,SENSIRION_NUM_WORDS(words));
    if (ret)
        return ret;
    /**
     * formulas for conversion of the sensor signals, optimized for fixed point
     * algebra:
     * Temperature = 175 * S_T / 65535 - 45
     * Relative Humidity = 125 * (S_RH / 65535) - 6
     */

    rawTemp = ((uint16_t) words[0] &lt;&lt; 8) | words[1];
    rawHumd = ((uint16_t) words[2] &lt;&lt; 8) | words[3];

    *temperature = (-45.0f + 175.0f * (rawTemp / 65535.0f));
    *humidity = (-6.0f + 125.0f * (rawHumd / 65535.0f)); 

    return ret;
}

</code></pre>
<h2 id="task-two">Task Two</h2>
<p>Great, now we can test if this works well. We need to use serial UART ST-LINK to display the current temperature and humidity in the terminal. Here is a test where we define main.c. We will do the first test by adding some code to transform a float into two parts: the integer part and the decimal part.</p>
<pre><code class="language-cpp">
#include &quot;libshield/sht4x.h&quot;
#define delay_us(us)        timer_wait_us(_TIM3, us)


static void on_command_received(char c) {
    command = c;
}

int main(void) {
    uart_init(_USART2, 115200, UART_8N1, on_command_received);
    i2c_master_init(_I2C1);
    while (sht4x_probe() != 0) {
        uart_printf(UART_TO_USE, &quot;SHT sensor probing failed\n&quot;);
        delay_us(1000);  // Sleep 1s
    }

    while (1) {
                float temperature, humidity;
                int8_t ret = sht4x_measure_blocking_read(&amp;temperature, &amp;humidity);
                if (ret == 0) {
                    int temp_int = (int) temperature;
                    float temp_frac = temperature - temp_int;
                    int hum_int = (int) humidity;
                    float hum_frac = humidity - hum_int;

                    int temp_int_frac = (int)(temp_frac * 1000);
                    int hum_int_frac = (int)(hum_frac * 1000);

                    uart_printf(UART_TO_USE, &quot;\r\ntemperature: %d.%d C&quot;, temp_int, temp_int_frac);
                    uart_printf(UART_TO_USE, &quot;\r\nhumidity: %d.%d&quot;, hum_int, hum_int_frac);

                    delay_us(1000);  // Sleep 1s

                } else {
                    uart_printf(UART_TO_USE, &quot;\r\nError reading measurement&quot;);
                }
                break;
    }
    return 0;
}

</code></pre>
<h2 id="summary">Summary</h2>
<p>In this section, we include the essential details about the SHT40 sensor, its basic functionalities, and how to interface it with a microcontroller to read and display temperature and humidity values using UART. We also provide a sample code implementation for initializing the sensor, reading data, and handling errors. After this, we will add more extra features and improvements to enhance the functionality and reliability of the system.</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js"></script>
        <script src="../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
